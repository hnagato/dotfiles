#!/usr/bin/env ruby

EDITOR = ENV['EDITOR'] || 'vim '

EXCLUDE_EXTENTSONS = %w(jpg png)
EXCLUDE_FROM_CURRENT = %w(estraier tmp log coverage)

ext      = EXCLUDE_EXTENTSONS.map{|ext| "! -name '*.#{ext}' "}.join
current  = EXCLUDE_FROM_CURRENT.map{|name| "! -path './#{name}/*' "}.join
patterns = ARGV.map{|v| "#{/^-/ === v ? '!' : ''} -path '*#{v.sub(/^-/, '')}*' "}.join

files = `find . -type f #{ext} #{current} ! -path '*/.svn/*' #{patterns}`.split

if files.empty?
  filename = ARGV[0].split(/\//).map{|v| "#{v}*"}.join("/")
  files = Dir.glob(filename)
  files.reject!{|path| File.directory?(path)}
end

unless files.empty?
  if /vim/ =~ EDITOR and files.size <= 10
    system("#{EDITOR} -O #{files.join(' ')}")
  else
    system("#{EDITOR} #{files.join(' ')}")
  end
  puts files
else
  $stderr.puts "Not found"
end
